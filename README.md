# 航空票务管理系统（C++ / Qt / MySQL）

本项目是一个基于 C++ 与 Qt 框架开发的桌面端航空票务管理系统，主要面向普通用户的机票查询与订单管理场景。系统支持用户登录注册、航班搜索与订票、订单支付与退票、个性化航班推荐以及账户设置等功能，底层采用 MySQL 数据库存储用户与订单数据，并通过自定义数据库访问类进行统一封装。

完整的设计说明、需求分析和测试截图详见仓库中的《软工实训开发报告.docx》与《航空票务管理系统开发报告》。  

## 功能概览

### 1. 用户登录与注册

- 支持用户名 + 密码 + 邮箱注册与登录。
- 密码使用 **随机盐 + SHA-256** 进行加密存储，提升账户安全性。
- 登录时从 `user_table` 中读取用户盐值，将用户输入密码加盐后进行 SHA-256 运算，比对密文判断是否登录成功。
- 支持查询与修改邮箱、重置密码等基础账户操作。

### 2. 航班查询与订票

- 用户可在“机票预订”界面选择出发城市、到达城市和出发日期，搜索符合条件的单程航班。
- 城市列表动态从 `citycode` 表中加载，支持下拉选择与输入模式（`QComboBox` 可编辑）。
- 如果用户选定日期当天没有符合条件的航班，系统会在用户选择日期的前后日期范围内（最多尝试若干天）继续搜索，尽可能为用户找到可选航班。
- 搜索结果以自定义条目形式展示，用户可点击“预订”按钮下单，生成订单并写入数据库。

### 3. 订单管理（支付 / 出票 / 完成 / 退票）

- 使用 `OrderInfo` 结构体保存订单信息，订单状态字段支持：
  - `1`：待支付  
  - `0`：已出票  
  - `-1`：已退票  
- 界面基于 `QListWidget + 自定义 QWidget (FrmItem)` 搭建，按不同维度展示订单：
  - 全部订单  
  - 待支付  
  - 已出票  
  - 已完成 / 已退票  
- 用户在“待支付”列表中点击订单，可确认支付，状态由“待支付”变为“已出票”，并写回数据库。
- 用户在“已出票”列表中可以发起退票操作，确认后订单状态变为“已退票”，同时在 UI 中移动到对应分类。
- 根据当前日期和航班起飞日期判断订单是否已完成，历史已完成订单会自动分类显示。

### 4. 每日推荐（个性化航班推荐）

- 系统根据用户的历史订单行为和所有用户的热门目的地，实现简单的个性化推荐算法：
  - 首先统计当前用户在历史订单中最常作为出发地的前两个城市。
  - 如果当前用户尚无历史订单，则从预设的热门大城市中随机选取两个作为出发地。
  - 然后统计全体用户订单中最热门的若干个到达城市（热门目的地），不足时由预设城市补齐。
  - 对于“用户常用出发地 × 热门目的地”的组合，在航班表中查询对应航班，并按价格或条件筛选，生成推荐列表。
- 推荐结果以列表形式返回，可以复用航班展示与订票组件进行交互。

### 5. 账户设置

- 显示并允许修改当前登录用户的邮箱等信息，密码改动同样会使用随机盐 + SHA-256 重新加密后存储。
- 基于简单的界面控制逻辑：初始状态为“只读”，点击“修改”按钮后进入编辑模式，再次点击后提交变更并更新数据库。

## 技术栈与架构

- 开发语言：C++
- GUI 框架：Qt 6（基于 QWidget / QDialog / QStackedWidget 等）
- 数据库：MySQL 8.0
- 连接方式：Qt SQL 模块（`QSqlDatabase` + `QSqlQuery`），使用 ODBC 驱动
- 操作系统：Windows 10
- 开发工具：Qt Creator

### 核心类与模块说明

#### 1. `DataBase`（数据库访问封装类）

负责与 MySQL 建立连接，并对主要业务操作进行封装，包括：

- 数据库连接初始化：
  - 使用 `QSqlDatabase::addDatabase("QODBC")` 创建连接；
  - 配置主机、端口、数据库名、用户名与密码；
  - 统一管理连接生命周期。
- 用户账户相关：
  - `generateSalt()`：生成随机盐值；
  - `hashPassword()`：对“密码+盐”进行 SHA-256 加密；
  - `signIn()`：用户注册写入 `user_table`；
  - `logIn()`：登录验证，按用户名查询盐值，再进行加密比对；
  - `ModifyPassword()` / `ModifyEMail()` / `FindUser()` / `QueryEmail()` 等基础操作。
- 航班查询：
  - `SearchSingleTicket(departCity, arriveCity, departDate)`：按出发城市、到达城市和出发日期查询 `airdata` 表，返回封装好的 `AirlineInfo` 列表。
- 每日推荐：
  - `GetTop10RecommendTickets(userName)`：
    - 先根据 `orderinfo` 中用户历史订单统计其常用出发城市；
    - 再按所有用户订单统计热门目的地；
    - 根据出发地 × 目的地组合查询 `airdata` 中的航班信息，选取若干价格较优的航班作为推荐结果。
  - `SearchRecommendTicket(arriveCity)`：按目的地查询推荐航班。
- 订单相关：
  - `InsertOrderInfo(OrderInfo info)`：用户下单，将订单写入 `orderinfo`；
  - `queryALLOrderInfo(userName)`：查询用户所有订单，并封装为 `OrderInfo` 列表；
  - `updateOrderStatus(const OrderInfo &orderInfo)`：更新订单状态（待支付→已出票、已出票→已退票等）。

#### 2. `FrmAirlineTicketBooking`（机票预订界面）

- 负责航班搜索界面交互：
  - 从 `citycode` 表读取城市列表，填充到出发/到达城市下拉框；
  - 支持交换出发地与目的地；
  - 输入出发日期后，调用 `DataBase::SearchSingleTicket` 搜索航班；
  - 若当日无航班，会在前后日期内进行多次尝试（限定尝试次数），找到最近有票的日期。
- 搜索成功后，弹出 `DlgOrderTicket` 对话框展示候选航班，让用户选择并下单。

#### 3. `DlgOrderTicket` + `Form`（订票对话框与航班项组件）

- `DlgOrderTicket`：
  - 使用 `QListWidget` 展示多个航班选项；
  - 每个航班条目由自定义 `Form` 组件渲染；
  - 用户在子组件中点击“预订”按钮，通过信号将选中的 `AirlineInfo` 发送回对话框。
- `Form`：
  - 展示航班的出发港、到达港、起降时间、价格、机型等基本信息；
  - 内部持有一个 `AirlineInfo` 实例，通过 `SendOrderInfo` 信号向外传递。

#### 4. `FrmAirlineTicketOrderManager` + `FrmItem`（订单管理界面及订单条目）

- `FrmAirlineTicketOrderManager`：
  - 使用多个 `QListWidget` 对订单进行分类展示（全部 / 待支付 / 已出票 / 已完成 / 已退票）；
  - 界面显示时自动调用 `InitData()`，从数据库读取当前用户订单列表，并用 `FrmItem` 进行渲染；
  - 在“待支付”列表中点击订单，会弹出确认对话框，确认后调用 `updateOrderStatus()` 将订单状态从待支付改为已出票；
  - 在“已出票”列表中点击订单，可执行退票操作，将状态改为已退票。
- `FrmItem`：
  - 接收一个 `OrderInfo` 对象，根据订单状态与当前日期设置 UI 显示：
    - 已完成（时间已过且未退票）；
    - 已出票；
    - 待支付；
    - 已退票。
  - 提供 `getOrderInfo()` 便于外部获取当前条目对应的订单信息。

#### 5. `MyData`（全局数据）

- 使用静态成员在全局范围内保存当前登录用户名以及订单缓存等信息，便于跨界面访问。

## 数据库设计概览

系统主要包含以下几张表（字段以实际数据库为准）：

- `user_table`：用户信息表  
  - `name`：用户名  
  - `password`：加密后的密码（SHA-256）  
  - `salt`：随机盐值  
  - `EMail`：用户邮箱  

- `airdata`：航班信息表  
  - 航班号、机型、起降时间、机场信息（城市、机场名、机场代码、航站楼）、出发日期、准点率、票价、航空公司、经停信息等。

- `citycode`：城市编码表  
  - 城市名及对应城市代码，用于下拉框展示与航班信息关联。

- `orderinfo`：用户订单表  
  - 用户名、订单状态、航班号、各类机场与时间信息、价格、航空公司、出发城市、到达城市等。

详细字段设计和 ER 结构可参考项目报告中的数据库字典与截图。

## 环境配置与运行步骤

1. **准备数据库**
   - 安装 MySQL 8.0，并创建用于本系统的数据库（例如 `airline_ticket`）。
   - 根据报告中的字段说明创建 `user_table`、`airdata`、`citycode`、`orderinfo` 等表。
   - 导入航班基础数据（可通过脚本或工具导入 CSV）。

2. **配置数据库连接**
   - 确保已安装并配置 MySQL ODBC 驱动。
   - 在 `DataBase::openDb()` 中，设置正确的：
     - 主机地址（通常为 `127.0.0.1` 或数据库服务器地址）；
     - 端口（一般为 `3306`）；
     - 数据库名称；
     - 用户名与密码。
   - 确认通过 Qt 工程能成功连接数据库。

3. **打开工程并编译**
   - 使用 Qt Creator 打开本项目。
   - 配置合适的 Kit（Qt 版本 + 编译器），执行 `qmake`/CMake 配置。
   - 正常构建（Build）工程，解决可能出现的库依赖问题。

4. **运行与测试**
   - 运行主程序，首先会进入登录/注册界面；
   - 成功登录后即可访问航班查询、订单管理、每日推荐和账户设置等界面；
   - 可按照报告中的测试用例逐项验证系统功能。

## 后续改进方向

根据当前开发记录，后续可考虑：

- **增加移动端支持**：开发 Android / iOS 客户端，提升用户使用便捷性。
- **优化推荐算法**：引入机器学习模型，对用户行为进行更加精细的建模，提升推荐准确度。
- **增强安全性**：
  - 增加多因素认证（如短信 / 邮箱验证码）；
  - 强化登录异常检测与日志审计。
- **完善订单业务**：
  - 支持多乘机人、多段行程和联程机票；
  - 集成实际支付网关模拟或沙盒。

---

如需了解本项目更完整的需求分析、详细设计、类图以及系统测试截图，请参阅仓库根目录中的《软工实训开发报告.docx》。
